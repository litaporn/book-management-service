# Book Management Service
This is a Book Management API using Spring Boot that allow you to create and get the books in the system. 

## Database Setup
### Steps to set up the database
To set up the database for this project, you can use the following SQL schema to create the required tables:

```sql
CREATE DATABASE manage_books;

CREATE TABLE books (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255) NOT NULL,
    published_date DATE NOT NULL
);
```

### Optimizing Queries with an Index on the Author Column

To handle a large number of books efficiently, an index is created on the author column of the books table. Use the following SQL statement to create the index:

```sql
CREATE INDEX idx_author ON books (author);
```

### Configure Database Connection
To configure your database connection in the `application.properties` file, add the following properties:

```properties
spring.datasource.url=jdbc:mysql://localhost:3306/manage_books
spring.datasource.username=root
spring.datasource.password=your_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```
Explan:
* spring.datasource.url: URL of your MySQL database
* spring.datasource.username: Your database username
* spring.datasource.password: Your database password
* spring.jpa.hibernate.ddl-auto=update: This setting automatically updates the database schema on application startup
* spring.jpa.show-sql=true: Shows SQL queries generated by Hibernate
* spring.jpa.properties.hibernate.format_sql=true: format the SQL queries for readability

## Instructions for Running the server

Before run the application, ensure your project is correctly configured to connect to the database.

#### Running the Application Locally

Follow the steps:

1. Clone the repository:
```bash
https://github.com/litaporn/book-management-service.git
```
2. Navigate to the project folder:
```bash
cd {path_local}/book-management
```
3. Run the application using the Spring Boot Maven:
```bash
./mvnw spring-boot:run
```

#### Optional: Run the Application Using IntelliJ IDEA

1. Ensure your project has no errors and the `application.properties` file is properly configured.
2. Click the "Run" button in IntelliJ IDEA. The application will start and the console output should look like this:
```bash   
2024-12-26T12:48:57.745+07:00  INFO 10752 --- [Book Management Service] [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 8080 (http) with context path '/'
2024-12-26T12:48:57.754+07:00  INFO 10752 --- [Book Management Service] [  restartedMain] c.a.l.b.BookManagementServiceApplication : Started BookManagementServiceApplication in 4.543 seconds (process running for 5.421)
```

The server will start on http://localhost:8080


## Integration Tests

Before running the integration tests, please ensure the following:

* The `manage_books_test` database is properly set up and connected

This project uses a separate environment for testing. Please follow these steps:

### Step 1: Create the Test Database
To set up the test database `manage_books_test` which is only used for testing, run the following SQL schema:

```sql
CREATE DATABASE manage_books_test;

CREATE TABLE books (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255) NOT NULL,
    published_date DATE NOT NULL
);

```

### Step 2: Configure **Test** Database Connection
In the `application-test.properties` file (used only for testing), add the following properties to configure the test database connection:

```properties
spring.datasource.url=jdbc:mysql://localhost:3306/manage_books_test
spring.datasource.username=root
spring.datasource.password=your_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```
Ensure that the connection is set to the `manage_books_test` database for testing.

### Step 3: Run the Integration Tests

To run the integration tests, just execute methods like `testSaveBook()` or `testGetBooksByAuthor()` in the `BookManagementServiceApplicationTests` class.

#### Running Integration Tests in IntelliJ IDEA

1. Ensure to create test database `manage_books_test` and the `application-test.properties` file is configured.
2. Open the `BookManagementServiceApplicationTests` class. 
3. Right-click on the test method (e.g., `testSaveBook()`) and select **Run 'testSaveBook()'**.
4. IntelliJ IDEA will run the test and show the results in the Run window.

* Mock Data for Testing (see the mock data in `BookManagementServiceApplicationTests` class)

| id  | author      | published_date | title        |
|-----|-------------|----------------|--------------|
| 32  | Author Test1| 2022-12-25     | Test Book 1  |
| 33  | Author Test2| 2023-01-15     | Test Book 2  |
| 34  | Author Test3| 2024-01-15     | Test Book 3  |

#### Using `mockMvc` for Integration Tests

`mockMvc` is a tool in Spring that helps you test HTTP requests without running a real server. It’s useful for testing API endpoints in integration tests.

#### Example of Integration Tests with `mockMvc`

Here’s how you can use `mockMvc` to test an HTTP POST request to the `/books` endpoint:

```java
String bookJson = "{ \"title\": \"Test Book 3\", \"author\": \"Author Test3\", \"publishedDate\": \"2567-01-15\" }";
mockMvc.perform(post("/books").contentType(MediaType.APPLICATION_JSON).content(bookJson))
        .andExpect(status().isCreated())
        .andExpect(jsonPath("$.title").value("Test Book 3")) 
        .andExpect(jsonPath("$.author").value("Author Test3"))
        .andExpect(jsonPath("$.publishedDate").value("2567-01-15"));
```

#### Expected Test Output
If the data in `bookJson` and the values in `andExpect` match up correctly, the test should **pass**, and you should see output like this:

```bash
Tests <p style="color: green;">passed</p>: 1 of 1 test - 1 sec 49ms
```

Try editing the test and expect it to **fail**:

```java
mockMvc.perform(post("/books").contentType(MediaType.APPLICATION_JSON).content(bookJson))
        .andExpect(status().isCreated())
        .andExpect(jsonPath("$.title").value("Test Book 4"))  
        .andExpect(jsonPath("$.author").value("Author Test3")) 
        .andExpect(jsonPath("$.publishedDate").value("2567-01-15"));
```

you might see an output like this:

```bash
Test <p style="color: red;">failed</p>: 1 of 1 test - 1 sec 77ms

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /books
       Parameters = {}
          Headers = [Content-Type:"application/json;charset=UTF-8", Content-Length:"83"]
             Body = { "title": "Test Book 3", "author": "Author Test3", "publishedDate": "2567-01-15" }
    Session Attrs = {}

Handler:
             Type = com.asc.library.bookmanagement.controller.BookController
           Method = com.asc.library.bookmanagement.controller.BookController#saveBook(Book)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null
             
ModelAndView:
        View name = null
             View = null
            Model = null

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 201
    Error message = null
          Headers = [Content-Type:"application/json"]
     Content type = application/json
             Body = {"id":49,"title":"Test Book 3","author":"Author Test3","publishedDate":"2567-01-15"}
    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: JSON path "$.title" expected:<Test Book 4> but was:<Test Book 3>
Expected :Test Book 4
Actual   :Test Book 3
```

## Example API requests and expected responses

### How to test the API with **Postman**
### 1. POST /books - Save a new book
#### Request:
```http
POST /books HTTP/1.1
Content-Type: application/json
Host: localhost:8080

{
    "title": "Test Book",
    "author": "Author Test",
    "publishedDate": "2565-12-21"
}
```
Response:
```json
{
    "id": 1,
    "title": "Test Book",
    "author": "Author Test",
    "publishedDate": "2565-12-21"
}
```
* Status : 201 Created


### 2. GET /books?author={authorName} - Get books by author
#### Request:
```http
GET /books?author=Author Test
Host: localhost:8080
```
Response:
```json
[
    {
        "id": 1,
        "title": "Test Book",
        "author": "Author Test",
        "publishedDate": "2565-12-21"
    }
]
```
* Status : 200 OK


The data will be inserted on the database as follows: 

| id  | author     | published_date | title       |
|-----|------------|----------------|-------------|
| 1   | Author Test| 2022-12-21     | Test Book   |

* `publishedDate` : Accepts the date in Buddhist Era (B.E.) format. The server will automatically convert it to Gregorian Calendar (C.E.) 
by subtracting 543 years before saving it in the database and convert it back to B.E. before sending it in the response.


## Error Handling
## 1. POST /books - Save a New Book
### 1.1 POST /books - Save a New Book (Title is Missing)
#### Request:
```http
POST /books HTTP/1.1
Content-Type: application/json
Host: localhost:8080

{
    "title": "",
    "author": "Author Test",
    "publishedDate": "2566-12-21"
}
```
Response:
```json
{
  "message": "Title must not be null."
}
```
* Status : 400 Bad Request

### 1.2 POST /books - Save a New Book (Author is Missing)
#### Request:
```http
POST /books HTTP/1.1
Content-Type: application/json
Host: localhost:8080

{
    "title": "Test Book",
    "author": "",
    "publishedDate": "2566-12-21"
}
```
Response:
```json
{
  "message": "Author must not be null."
}
```
* Status : 400 Bad Request

### 1.3 POST /books - Save a New Book (Invalid publishedDate)
#### Request:
```http
POST /books HTTP/1.1
Content-Type: application/json
Host: localhost:8080

{
    "title": "Test Book",
    "author": "Author Test",
    "publishedDate": "2569-12-21"
}
```
Response:
```json
{
  "message": "Published date must be less than or equal to the current year."
}
```
* Status : 400 Bad Request

## 2. GET /books?author={authorName} - Get Books by Author
### 2.1 GET /books?author= Get Books by Author (Author Name is Missing)
#### Request:
```http
GET /books?author=
Host: localhost:8080
```
Response:
```json
{
  "message": "Author must not be null."
}
```
* Status : 400 Bad Request

### 2.2 GET /books?author={authorName} Get Books by Author (AuthorName Not Found)
#### Request:
```http
GET /books?author=Test
Host: localhost:8080
```
Response:
```json
{
  "message": "No books found for the specified author."
}
```
* Status : 404 Not Found